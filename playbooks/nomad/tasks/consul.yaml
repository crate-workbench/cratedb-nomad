---

- name: Ensure consul directories
  tags: consul
  file:
    path: "{{ item.dir }}"
    #owner: consul
    #group: consul
    state: directory
    mode: '0755'
  loop:
    - { dir: '/opt/consul' }
    - { dir: '/etc/consul.d' }

- name: Ensure consul key material
  tags: consul
  ansible.builtin.copy:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
   # owner: nomad
   # group: nomad
    mode: 0644
  loop:
  # consul keygen --> store in group_vars/nomad.yaml
  # consul tls ca create --> run in ./files directory
  # consul tls cert create -server -dc dc1 -domain consul --> run in ./files directory
  # yes! good you asked. You would want separate certs for each server and client
  # for your production
    - { src: 'consul-agent-ca-key.pem', dest: '/etc/consul.d/' }
    - { src: 'consul-agent-ca.pem', dest: '/etc/consul.d/' }
    - { src: 'dc1-server-consul-0.pem', dest: '/etc/consul.d/' }
    - { src: 'dc1-server-consul-0-key.pem', dest: '/etc/consul.d/' }
  notify: restart nomad

- name: Download HashiCorp GPG key
  shell: |
    curl --fail --silent --show-error --location https://apt.releases.hashicorp.com/gpg |
    gpg --dearmor |
    sudo dd of=/usr/share/keyrings/hashicorp-archive-keyring.gpg
  args:
    executable: /bin/bash

- name: Ensure hashicorp apt repository for JAMMY !!!!
  tags: consul
  ansible.builtin.copy:
    src: hashicorp.list
    dest: /etc/apt/sources.list.d/
    mode: 0644

- name: Update apt cache
  apt:
    update_cache: yes

- name: install consul
  apt:
    name: consul
    state: latest
    update_cache: yes


- name: Configure systemd to use service
  tags: consul
  systemd:
    daemon_reload: yes
    enabled: yes
    state: started
    name: consul.service
  notify: restart consul

- name: Template consul config file
  tags: consul
  template:
    dest: /etc/consul.d/consul.hcl
    src: consul.hcl.j2
    #owner: consul
    #group: consul
    mode: '0640'
    lstrip_blocks: yes
    trim_blocks: no
  notify: restart consul
  ignore_errors: yes ### ATM I ignore this

- name: Ensure consul DNS resolves on volumes
  tags: resolved
  blockinfile:
    path: /etc/systemd/resolved.conf
    marker: "#<-- {mark} ANSIBLE MANAGED BLOCK -->"
    block: |
      [Resolve]
      DNS=127.0.0.1:8600
      DNSSEC=false
      Domains=~consul
  notify: restart resolved
